<style>
  .adb-dialog {
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: var(--color-text-primary, #333);
    max-width: 600px;
  }
  .adb-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .adb-form-group {
    display: flex;
    flex-direction: column;
  }
  .adb-form-group > label {
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--color-text-primary, #333);
  }
  .adb-toggle-switch {
    position: relative;
    width: 50px;
    height: 28px;
    margin-top: 8px;
  }
  .adb-toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .adb-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 28px;
  }
  .adb-toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  .adb-toggle-switch input:checked + .adb-toggle-slider {
    background-color: var(--color-accent, #4a90e2);
  }
  .adb-toggle-switch input:checked + .adb-toggle-slider:before {
    transform: translateX(22px);
  }
  .adb-help-text {
    font-size: 0.85rem;
    color: var(--color-text-secondary, #666);
    margin-top: 6px;
    line-height: 1.4;
  }
  .adb-monaco-container {
    height: 80px;
    border: 1px solid var(--color-border, #ddd);
    border-radius: 4px;
    overflow: hidden;
  }
  .adb-button-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--color-border, #ddd);
  }
  .adb-btn {
    padding: 10px 24px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
  }
  .adb-btn-secondary {
    background: var(--color-surface, #fff);
    border: 1px solid var(--color-border, #ddd);
    color: var(--color-text-primary, #333);
  }
  .adb-btn-secondary:hover {
    background: var(--color-surface-muted, #f5f5f5);
  }
  .adb-btn-primary {
    background: var(--color-accent, #4a90e2);
    border: 1px solid var(--color-accent, #4a90e2);
    color: white;
  }
  .adb-btn-primary:hover {
    background: var(--color-accent-hover, #3a7bc8);
  }
</style>
<div class="adb-dialog">
  <div class="adb-form-row">
    <div class="adb-form-group">
      <label>Retract Sequence</label>
      <div class="adb-monaco-container" id="adb-retractCommand-editor"></div>
      <p class="adb-help-text">G-code sequence to retract the dust boot</p>
    </div>

    <div class="adb-form-group">
      <label>Expand Sequence</label>
      <div class="adb-monaco-container" id="adb-expandCommand-editor"></div>
      <p class="adb-help-text">G-code sequence to expand the dust boot</p>
    </div>
  </div>

  <div class="adb-form-row">
    <div class="adb-form-group">
      <label>Retract on Home</label>
      <label class="adb-toggle-switch">
        <input type="checkbox" id="adb-retractOnHome" checked>
        <span class="adb-toggle-slider"></span>
      </label>
      <p class="adb-help-text">Automatically retract when homing ($H)</p>
    </div>

    <div class="adb-form-group">
      <label>Retract on Rapid Move (G0)</label>
      <label class="adb-toggle-switch">
        <input type="checkbox" id="adb-retractOnRapidMove" checked>
        <span class="adb-toggle-slider"></span>
      </label>
      <p class="adb-help-text">Retract during rapid moves (except when running jobs)</p>
    </div>
  </div>

  <div class="adb-form-row">
    <div class="adb-form-group">
      <label>Show Added GCode in Terminal</label>
      <label class="adb-toggle-switch">
        <input type="checkbox" id="adb-showAddedGCode">
        <span class="adb-toggle-slider"></span>
      </label>
      <p class="adb-help-text">When disabled, commands are executed silently</p>
    </div>
  </div>

  <div class="adb-button-row">
    <button type="button" class="adb-btn adb-btn-secondary" onclick="window.postMessage({ type: 'close-plugin-dialog' }, '*')">Close</button>
    <button type="button" class="adb-btn adb-btn-primary" id="adb-saveBtn">Save</button>
  </div>
</div>

<script>
  (function() {
    var FALLBACK_PORT = __SERVER_PORT__;
    var DEFAULT_RETRACT = 'M8\nG4 P0.1\nM9';
    var DEFAULT_EXPAND = 'M8';

    var retractEditor = null;
    var expandEditor = null;

    var resolveApiBaseUrl = function() {
      if (window.ncSender && typeof window.ncSender.getApiBaseUrl === 'function') {
        return window.ncSender.getApiBaseUrl(FALLBACK_PORT);
      }
      return '';
    };

    var BASE_URL = resolveApiBaseUrl();

    // Register G-code language and theme if not already registered
    function registerGcodeLanguage() {
      if (typeof monaco === 'undefined') return;

      // Check if already registered
      var languages = monaco.languages.getLanguages();
      if (languages.some(function(lang) { return lang.id === 'gcode'; })) return;

      monaco.languages.register({ id: 'gcode' });

      monaco.languages.setMonarchTokensProvider('gcode', {
        tokenizer: {
          root: [
            [/\(.*?\)/, 'comment'],
            [/;.*$/, 'comment'],
            [/\b[Gg]0*(?=\s|$|[A-Za-z])/, 'gcode-rapid'],
            [/\b[Gg][1-3]\b/, 'gcode-cutting'],
            [/\b[Gg]\d+\.?\d*/, 'gcode-g'],
            [/\b[Mm]\d+/, 'gcode-m'],
            [/\b[Tt]\d+/, 'gcode-tool'],
            [/\b[Ss]\d+\.?\d*/, 'gcode-spindle'],
            [/\b[Ff]\d+\.?\d*/, 'gcode-feed'],
            [/\b[Xx]-?\d+\.?\d*/, 'gcode-coord-x'],
            [/\b[Yy]-?\d+\.?\d*/, 'gcode-coord-y'],
            [/\b[Zz]-?\d+\.?\d*/, 'gcode-coord-z'],
            [/\b[AaBbCcIiJjKk]-?\d+\.?\d*/, 'gcode-coord-other'],
            [/\b[Nn]\d+/, 'gcode-line-number'],
            [/-?\d+\.?\d*/, 'number'],
          ]
        }
      });

      monaco.editor.defineTheme('gcode-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },
          { token: 'gcode-rapid', foreground: 'FF8C00', fontStyle: 'bold' },
          { token: 'gcode-cutting', foreground: '569CD6', fontStyle: 'bold' },
          { token: 'gcode-g', foreground: 'C586C0' },
          { token: 'gcode-m', foreground: 'DCDCAA' },
          { token: 'gcode-tool', foreground: '4EC9B0' },
          { token: 'gcode-spindle', foreground: 'CE9178' },
          { token: 'gcode-feed', foreground: 'B5CEA8' },
          { token: 'gcode-coord-x', foreground: 'F14C4C' },
          { token: 'gcode-coord-y', foreground: '4EC9B0' },
          { token: 'gcode-coord-z', foreground: '569CD6' },
          { token: 'gcode-coord-other', foreground: '9CDCFE' },
          { token: 'gcode-line-number', foreground: '858585' },
          { token: 'number', foreground: 'B5CEA8' },
        ],
        colors: {}
      });

      monaco.editor.defineTheme('gcode-light', {
        base: 'vs',
        inherit: true,
        rules: [
          { token: 'comment', foreground: '008000', fontStyle: 'italic' },
          { token: 'gcode-rapid', foreground: 'FF6600', fontStyle: 'bold' },
          { token: 'gcode-cutting', foreground: '0000FF', fontStyle: 'bold' },
          { token: 'gcode-g', foreground: 'AF00DB' },
          { token: 'gcode-m', foreground: '795E26' },
          { token: 'gcode-tool', foreground: '267F99' },
          { token: 'gcode-spindle', foreground: 'A31515' },
          { token: 'gcode-feed', foreground: '098658' },
          { token: 'gcode-coord-x', foreground: 'CD3131' },
          { token: 'gcode-coord-y', foreground: '267F99' },
          { token: 'gcode-coord-z', foreground: '0000FF' },
          { token: 'gcode-coord-other', foreground: '001080' },
          { token: 'gcode-line-number', foreground: '858585' },
          { token: 'number', foreground: '098658' },
        ],
        colors: {}
      });
    }

    registerGcodeLanguage();

    var isLightTheme = function() { return document.body.classList.contains('theme-light'); };
    var getMonacoTheme = function() { return isLightTheme() ? 'gcode-light' : 'gcode-dark'; };

    var monacoOptions = {
      language: 'gcode',
      theme: getMonacoTheme(),
      minimap: { enabled: false },
      lineNumbers: 'on',
      scrollBeyondLastLine: false,
      automaticLayout: true,
      fontSize: 12,
      tabSize: 2
    };

    function init() {
      // Load settings
      var settingsUrl = BASE_URL + '/api/plugins/com.ncsender.autodustboot/settings';
      fetch(settingsUrl)
        .then(function(response) {
          if (response.ok) return response.json();
          return {};
        })
        .then(function(settings) {
          if (!settings) settings = {};
          initUI(settings);
        })
        .catch(function(error) {
          console.error('Failed to load settings:', error);
          initUI({});
        });
    }

    function initUI(settings) {
      // Initialize Monaco editors
      if (typeof monaco !== 'undefined') {
        var retractContainer = document.getElementById('adb-retractCommand-editor');
        if (retractContainer) {
          retractEditor = monaco.editor.create(retractContainer, Object.assign({}, monacoOptions, {
            value: settings.retractCommand || DEFAULT_RETRACT
          }));
        }

        var expandContainer = document.getElementById('adb-expandCommand-editor');
        if (expandContainer) {
          expandEditor = monaco.editor.create(expandContainer, Object.assign({}, monacoOptions, {
            value: settings.expandCommand || DEFAULT_EXPAND
          }));
        }

        // Watch for theme changes
        var themeObserver = new MutationObserver(function() {
          monaco.editor.setTheme(getMonacoTheme());
        });
        themeObserver.observe(document.body, { attributes: true, attributeFilter: ['class'] });
      }

      // Load toggle values
      document.getElementById('adb-retractOnHome').checked = settings.retractOnHome !== undefined ? settings.retractOnHome : true;
      document.getElementById('adb-retractOnRapidMove').checked = settings.retractOnRapidMove !== undefined ? settings.retractOnRapidMove : true;
      document.getElementById('adb-showAddedGCode').checked = settings.showAddedGCode !== undefined ? settings.showAddedGCode : false;
    }

    function saveAndClose() {
      var retractCommand = retractEditor ? retractEditor.getValue().trim() : '';
      var expandCommand = expandEditor ? expandEditor.getValue().trim() : '';
      var retractOnHome = document.getElementById('adb-retractOnHome').checked;
      var retractOnRapidMove = document.getElementById('adb-retractOnRapidMove').checked;
      var showAddedGCode = document.getElementById('adb-showAddedGCode').checked;

      var settings = {
        retractCommand: retractCommand,
        expandCommand: expandCommand,
        retractOnHome: retractOnHome,
        retractOnRapidMove: retractOnRapidMove,
        showAddedGCode: showAddedGCode
      };

      var settingsUrl = BASE_URL + '/api/plugins/com.ncsender.autodustboot/settings';
      fetch(settingsUrl, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
      })
        .then(function() {
          window.postMessage({ type: 'close-plugin-dialog' }, '*');
        })
        .catch(function(error) {
          console.error('Failed to save settings:', error);
        });
    }

    document.getElementById('adb-saveBtn').addEventListener('click', saveAndClose);
    init();
  })();
</script>
